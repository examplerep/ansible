---
- name: Setup RHDP Environment
  hosts: localhost
  gather_facts: false

  pre_tasks:
    - name: Validate required configuration
      ansible.builtin.assert:
        that:
          - sandbox_id | length > 0
          - cloudflare_api_token | length > 0
        fail_msg: |
          Missing required configuration:
            - SANDBOX_ID environment variable
            - ~/.cloudflare_api_token file
            - ~/.aws/credentials file
        success_msg: "All required configuration is present"

  tasks:
    # =========================================================================
    # Route53 - Create Hosted Zone
    # =========================================================================
    - name: Create Route53 hosted zone for {{ ocp_domain }}
      amazon.aws.route53_zone:
        zone: "{{ ocp_domain }}"
        state: present
        comment: "OpenShift cluster zone for Example Power - Sandbox {{ sandbox_id }}"
        region: "{{ aws_region }}"
      register: route53_zone

    - name: Get Route53 hosted zone name servers
      ansible.builtin.command:
        cmd: aws route53 get-hosted-zone --id {{ route53_zone.zone_id }} --query 'DelegationSet.NameServers' --output json
      register: route53_ns_result
      changed_when: false

    - name: Set name servers fact
      ansible.builtin.set_fact:
        route53_name_servers: "{{ route53_ns_result.stdout | from_json }}"

    - name: Display Route53 hosted zone info
      ansible.builtin.debug:
        msg:
          - "Zone ID: {{ route53_zone.zone_id }}"
          - "Name Servers: {{ route53_name_servers }}"

    # =========================================================================
    # Cloudflare - Create NS Records
    # =========================================================================
    - name: Get Cloudflare zone ID
      ansible.builtin.uri:
        url: "https://api.cloudflare.com/client/v4/zones?name={{ base_domain }}"
        method: GET
        headers:
          Authorization: "Bearer {{ cloudflare_api_token }}"
        return_content: true
      register: cloudflare_zone_result

    - name: Set Cloudflare zone ID fact
      ansible.builtin.set_fact:
        cloudflare_zone_id: "{{ cloudflare_zone_result.json.result[0].id }}"

    - name: Get existing NS records from Cloudflare
      ansible.builtin.uri:
        url: "https://api.cloudflare.com/client/v4/zones/{{ cloudflare_zone_id }}/dns_records?type=NS&name={{ ocp_subdomain }}.{{ base_domain }}"
        method: GET
        headers:
          Authorization: "Bearer {{ cloudflare_api_token }}"
        return_content: true
      register: existing_ns_records

    - name: Set existing NS records fact
      ansible.builtin.set_fact:
        existing_ns_values: "{{ existing_ns_records.json.result | map(attribute='content') | list }}"
        existing_ns_record_ids: "{{ existing_ns_records.json.result | map(attribute='id') | list }}"

    - name: Check if NS records need updating
      ansible.builtin.set_fact:
        ns_records_match: "{{ (existing_ns_values | sort) == (route53_name_servers | sort) }}"

    - name: Display existing NS records status
      ansible.builtin.debug:
        msg: "Existing NS records match Route53 name servers, skipping update"
      when: ns_records_match

    - name: Delete existing NS records from Cloudflare
      community.general.cloudflare_dns:
        zone: "{{ base_domain }}"
        api_token: "{{ cloudflare_api_token }}"
        state: absent
        type: NS
        record: "{{ ocp_subdomain }}"
        value: "{{ item }}"
      loop: "{{ existing_ns_values }}"
      when: not ns_records_match and existing_ns_values | length > 0

    - name: Create NS records in Cloudflare pointing to Route53
      community.general.cloudflare_dns:
        zone: "{{ base_domain }}"
        api_token: "{{ cloudflare_api_token }}"
        state: present
        type: NS
        record: "{{ ocp_subdomain }}"
        value: "{{ item }}"
      loop: "{{ route53_name_servers }}"
      register: cloudflare_ns_records
      when: not ns_records_match

    - name: Display Cloudflare NS records created
      ansible.builtin.debug:
        msg: "Created NS record: {{ ocp_subdomain }}.{{ base_domain }} -> {{ item.item }}"
      loop: "{{ cloudflare_ns_records.results }}"
      when: not ns_records_match and item.changed

    # =========================================================================
    # AWS Secrets Manager - Create Secrets
    # =========================================================================
    - name: Check if secret foo exists
      ansible.builtin.command:
        cmd: aws secretsmanager describe-secret --secret-id foo --region {{ aws_region }}
      register: secret_foo_check
      changed_when: false
      failed_when: false

    - name: Create AWS Secrets Manager secret - foo
      ansible.builtin.command:
        cmd: >
          aws secretsmanager create-secret
          --name foo
          --description "Example Power secret"
          --secret-string "bar"
          --region {{ aws_region }}
      register: secrets_manager_foo_create
      when: secret_foo_check.rc != 0

    - name: Update AWS Secrets Manager secret - foo
      ansible.builtin.command:
        cmd: >
          aws secretsmanager put-secret-value
          --secret-id foo
          --secret-string "bar"
          --region {{ aws_region }}
      register: secrets_manager_foo_update
      when: secret_foo_check.rc == 0
      changed_when: true

    - name: Get secret ARN
      ansible.builtin.command:
        cmd: aws secretsmanager describe-secret --secret-id foo --query 'ARN' --output text --region {{ aws_region }}
      register: secret_foo_arn
      changed_when: false

    - name: Display Secrets Manager info
      ansible.builtin.debug:
        msg:
          - "Secret: foo"
          - "ARN: {{ secret_foo_arn.stdout }}"

    # =========================================================================
    # Summary
    # =========================================================================
    - name: Display RHDP environment setup summary
      ansible.builtin.debug:
        msg:
          - "=============================================="
          - "RHDP Environment Setup Complete"
          - "=============================================="
          - "Sandbox ID: {{ sandbox_id }}"
          - "Sandbox Base Domain: {{ sandbox_base_domain }}"
          - ""
          - "Route53 Hosted Zone:"
          - "  Zone: {{ ocp_domain }}"
          - "  Zone ID: {{ route53_zone.zone_id }}"
          - ""
          - "Cloudflare NS Delegation:"
          - "  {{ ocp_subdomain }}.{{ base_domain }} -> Route53 Name Servers"
          - ""
          - "Name Servers:"
          - "  {{ route53_name_servers | join('\n  ') }}"
          - ""
          - "AWS Secrets Manager:"
          - "  Secret: foo"
          - "  ARN: {{ secret_foo_arn.stdout }}"
          - "=============================================="
